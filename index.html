<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExpenseFlow Pro</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <!-- PWA Manifest (Data URI) -->
    <link rel="manifest" id="manifest-placeholder">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite;
            /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            .mobile-hide {
                display: none;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                position: fixed;
                z-index: 50;
                height: 100vh;
                width: 280px;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }

            .overlay.active {
                display: block;
            }
        }
    </style>
</head>

<body class="text-gray-800 h-screen flex overflow-hidden">

    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar bg-slate-900 text-white w-64 flex-shrink-0 flex flex-col h-full shadow-2xl">
        <div class="p-6 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                    <i class="fa-solid fa-indian-rupee-sign text-white text-sm"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight">ExpenseFlow</h1>
            </div>
            <button class="md:hidden text-gray-400 hover:text-white" onclick="toggleSidebar()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <nav class="flex-1 px-4 py-4 space-y-2">
            <a href="#" onclick="showPage('dashboard')" id="nav-dashboard"
                class="nav-item flex items-center gap-3 px-4 py-3 bg-blue-600 rounded-xl text-white transition-colors">
                <i class="fa-solid fa-chart-pie w-5"></i>
                <span class="font-medium">Dashboard</span>
            </a>
            <a href="#" onclick="showPage('transactions')" id="nav-transactions"
                class="nav-item flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-xl transition-colors">
                <i class="fa-solid fa-list-ul w-5"></i>
                <span class="font-medium">Transactions</span>
            </a>
            <!-- Install Button (Hidden by default, shown if PWA installable) -->
            <button id="installBtn"
                class="hidden w-full flex items-center gap-3 px-4 py-3 text-emerald-400 hover:text-emerald-300 hover:bg-slate-800 rounded-xl transition-colors text-left mt-8">
                <i class="fa-solid fa-download w-5"></i>
                <span class="font-medium">Install App</span>
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <div class="flex items-center gap-3 px-4 py-2">
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold"
                    id="userAvatar">U</div>
                <div>
                    <p class="text-sm font-medium text-white">My Wallet</p>
                    <p class="text-xs text-slate-400" id="userIdDisplay">Connecting...</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden bg-gray-50 relative">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 flex-shrink-0">
            <button class="md:hidden text-gray-600 p-2 -ml-2 hover:bg-gray-100 rounded-lg" onclick="toggleSidebar()">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
            <h2 id="pageTitle" class="text-lg font-semibold text-gray-800">Dashboard</h2>
            <button onclick="openModal()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm flex items-center gap-2">
                <i class="fa-solid fa-plus"></i>
                <span class="hidden sm:inline">Add Transaction</span>
            </button>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8" id="mainScroll">

            <!-- Dashboard View -->
            <div id="view-dashboard" class="space-y-6 max-w-7xl mx-auto">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Balance -->
                    <div
                        class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-6 opacity-10 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-scale-balanced text-6xl text-blue-600"></i>
                        </div>
                        <p class="text-sm text-gray-500 font-medium mb-1">Total Balance</p>
                        <h3 class="text-3xl font-bold text-gray-800" id="totalBalance">₹0.00</h3>
                        <div class="mt-4 flex items-center text-xs text-gray-400">
                            <i class="fa-solid fa-shield-halved mr-1"></i> Secure & Synced
                        </div>
                    </div>

                    <!-- Income -->
                    <div
                        class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-6 opacity-10 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-arrow-trend-up text-6xl text-emerald-500"></i>
                        </div>
                        <p class="text-sm text-gray-500 font-medium mb-1">Total Income</p>
                        <h3 class="text-3xl font-bold text-emerald-600" id="totalIncome">₹0.00</h3>
                        <div class="mt-4 w-full bg-gray-100 rounded-full h-1.5">
                            <div class="bg-emerald-500 h-1.5 rounded-full" style="width: 100%"></div>
                        </div>
                    </div>

                    <!-- Expenses -->
                    <div
                        class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-6 opacity-10 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-arrow-trend-down text-6xl text-rose-500"></i>
                        </div>
                        <p class="text-sm text-gray-500 font-medium mb-1">Total Expenses</p>
                        <h3 class="text-3xl font-bold text-rose-600" id="totalExpense">₹0.00</h3>
                        <div class="mt-4 w-full bg-gray-100 rounded-full h-1.5">
                            <div class="bg-rose-500 h-1.5 rounded-full" id="expenseBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Charts & Recent -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Chart Section -->
                    <div
                        class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                        <h3 class="text-lg font-bold text-gray-800 w-full mb-4">Expense Breakdown</h3>
                        <div class="relative w-full max-w-[280px]">
                            <canvas id="expenseChart"></canvas>
                        </div>
                        <div id="chartLegend" class="w-full mt-6 space-y-2 text-sm"></div>
                    </div>

                    <!-- Recent Transactions -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-800">Recent Transactions</h3>
                            <button onclick="showPage('transactions')"
                                class="text-sm text-blue-600 hover:text-blue-700 font-medium">View All</button>
                        </div>
                        <div class="overflow-y-auto flex-1 pr-2" style="max-height: 400px;">
                            <div id="recentList" class="space-y-3">
                                <!-- Items injected here -->
                                <div class="text-center py-10 text-gray-400">
                                    <div class="loader mx-auto mb-3"></div>
                                    <p>Loading data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transactions View (Hidden by default) -->
            <div id="view-transactions" class="hidden max-w-5xl mx-auto">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div
                        class="p-6 border-b border-gray-100 flex flex-col sm:flex-row gap-4 justify-between items-center bg-gray-50">
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <div class="relative w-full sm:w-64">
                                <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400 text-sm"></i>
                                <input type="text" id="searchInput" placeholder="Search notes or categories..."
                                    class="w-full pl-9 pr-4 py-2 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            </div>
                            <div class="flex gap-2">
                                <select id="filterType"
                                    class="px-3 py-2 bg-white border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="all">All Types</option>
                                    <option value="income">Income</option>
                                    <option value="expense">Expense</option>
                                </select>
                            </div>
                        </div>
                        <!-- New Export Button -->
                        <button onclick="exportCSV()"
                            class="mt-3 sm:mt-0 text-gray-600 hover:text-gray-900 text-sm font-medium flex items-center gap-2 px-3 py-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="fa-solid fa-file-csv text-green-600 text-lg"></i>
                            Export CSV
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr
                                    class="bg-gray-50 text-xs uppercase text-gray-500 font-semibold border-b border-gray-100">
                                    <th class="px-6 py-4 rounded-tl-lg">Category</th>
                                    <th class="px-6 py-4">Date</th>
                                    <th class="px-6 py-4">Note</th>
                                    <th class="px-6 py-4 text-right">Amount</th>
                                    <th class="px-6 py-4 rounded-tr-lg text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="fullTransactionList" class="text-sm divide-y divide-gray-100">
                                <!-- Full list injected here -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Empty State -->
                    <div id="emptyState" class="hidden py-12 flex flex-col items-center justify-center text-gray-400">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                            <i class="fa-solid fa-receipt text-2xl text-gray-300"></i>
                        </div>
                        <p>No transactions found.</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Add/Edit Modal -->
    <div id="transactionModal" class="fixed inset-0 z-50 hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>

        <!-- Modal Content -->
        <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-4">
            <div class="bg-white rounded-2xl shadow-2xl transform transition-all scale-100 opacity-100">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800" id="modalTitle">Add Transaction</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>

                <form id="transactionForm" class="p-6 space-y-4">
                    <input type="hidden" id="editId">

                    <!-- Type Toggle -->
                    <div class="grid grid-cols-2 gap-2 bg-gray-100 p-1 rounded-xl">
                        <button type="button" onclick="setType('expense')" id="btn-expense"
                            class="py-2 rounded-lg text-sm font-medium transition-all shadow-sm bg-white text-rose-600">Expense</button>
                        <button type="button" onclick="setType('income')" id="btn-income"
                            class="py-2 rounded-lg text-sm font-medium transition-all text-gray-500 hover:text-gray-700">Income</button>
                    </div>
                    <input type="hidden" id="type" value="expense">

                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Amount</label>
                        <div class="relative">
                            <!-- Updated Currency Symbol -->
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">₹</span>
                            <input type="number" step="0.01" id="amount" required
                                class="w-full pl-8 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all font-mono text-lg"
                                placeholder="0.00">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Category</label>
                        <select id="category"
                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all appearance-none cursor-pointer">
                            <!-- Options injected by JS based on type -->
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Date</label>
                        <input type="date" id="date" required
                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-gray-600">
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Note (Optional)</label>
                        <input type="text" id="note"
                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                            placeholder="What was this for?">
                    </div>

                    <button type="submit"
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200 transition-all transform active:scale-95 mt-2">
                        Save Transaction
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Script Logic -->
    <script>
        /**
         * PWA CONFIGURATION
         * Generating Manifest dynamically to keep file count to 1.
         */
        const manifest = {
            "name": "ExpenseFlow Pro",
            "short_name": "ExpenseFlow",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#2563eb",
            "icons": [
                {
                    "src": "https://cdn-icons-png.flaticon.com/512/2382/2382533.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        document.getElementById('manifest-placeholder').href = URL.createObjectURL(manifestBlob);

        // NOTE: Service Worker registration removed due to "blob:" protocol restrictions 
        // in iframe/sandboxed environments. This ensures the app runs without error.

        // Install Prompt Logic
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').classList.remove('hidden');
        });
        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('installBtn').classList.add('hidden');
            }
        });

        /**
         * APP LOGIC
         */

        // DEFAULT CATEGORIES FOR SEEDING (Flattened structure for easier DB insert)
        const defaultCategoriesList = [
            // Expense
            { id: 'food', type: 'expense', name: 'Food & Dining', icon: 'fa-utensils', color: '#f87171' },
            { id: 'transport', type: 'expense', name: 'Transportation', icon: 'fa-car', color: '#60a5fa' },
            { id: 'shopping', type: 'expense', name: 'Shopping', icon: 'fa-bag-shopping', color: '#c084fc' },
            { id: 'bills', type: 'expense', name: 'Bills & Utilities', icon: 'fa-bolt', color: '#fbbf24' },
            { id: 'entertainment', type: 'expense', name: 'Entertainment', icon: 'fa-film', color: '#f472b6' },
            { id: 'health', type: 'expense', name: 'Health', icon: 'fa-heart-pulse', color: '#34d399' },
            { id: 'other', type: 'expense', name: 'Others', icon: 'fa-circle-question', color: '#94a3b8' },
            // Income
            { id: 'salary', type: 'income', name: 'Salary', icon: 'fa-money-bill-wave', color: '#10b981' },
            { id: 'freelance', type: 'income', name: 'Freelance', icon: 'fa-laptop-code', color: '#3b82f6' },
            { id: 'investments', type: 'income', name: 'Investments', icon: 'fa-chart-line', color: '#8b5cf6' },
            { id: 'gift', type: 'income', name: 'Gifts', icon: 'fa-gift', color: '#ec4899' },
            { id: 'other_income', type: 'income', name: 'Other Income', icon: 'fa-plus-circle', color: '#64748b' }
        ];

        // Reactive Category State
        let categories = {
            expense: [],
            income: []
        };

        // FIREBASE SETUP
        const firebaseConfig = {
            apiKey: "AIzaSyBSU62EbaZWvRQzhf9nc5hY7-MYhm4Kqyo",
            authDomain: "budgetmaster-d0cbd.firebaseapp.com",
            projectId: "budgetmaster-d0cbd",
            storageBucket: "budgetmaster-d0cbd.firebasestorage.app",
            messagingSenderId: "540237476220",
            appId: "1:540237476220:web:c4026abb2d1e06e360f4f9",
            measurementId: "G-YPK4ZWQLMT"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;
        let transactions = [];
        let expenseChart = null;

        // INITIALIZATION
        async function initApp() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await auth.signInWithCustomToken(__initial_auth_token);
            } else {
                await auth.signInAnonymously();
            }

            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('userIdDisplay').textContent = `ID: ${user.uid.substring(0, 6)}...`;
                    setupCategoriesListener(); // Load categories first
                    setupRealtimeListener(); // Then transactions
                }
            });

            // Set default date to today
            document.getElementById('date').valueAsDate = new Date();
        }

        // CATEGORIES LISTENER & SEEDER
        function setupCategoriesListener() {
            if (!currentUser) return;

            const catsRef = db.collection('artifacts')
                .doc(appId)
                .collection('users')
                .doc(currentUser.uid)
                .collection('categories');

            catsRef.onSnapshot(async (snapshot) => {
                if (snapshot.empty) {
                    console.log("No categories found. Seeding defaults...");
                    await seedDefaultCategories(catsRef);
                    return;
                }

                // Reset local state
                categories = { expense: [], income: [] };

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.type === 'expense') categories.expense.push(data);
                    else if (data.type === 'income') categories.income.push(data);
                });

                // Update UI components that depend on categories
                updateCategoryOptions();
                updateUI(); // Re-render lists/charts with new category metadata

            }, (error) => {
                console.error("Categories fetch error:", error);
            });
        }

        async function seedDefaultCategories(ref) {
            // Batch write for atomicity
            const batch = db.batch();

            defaultCategoriesList.forEach(cat => {
                // Create a doc reference with specific ID if possible, or auto-id
                // Here we use the cat.id as the doc ID for easier deduping
                const docRef = ref.doc(cat.id);
                batch.set(docRef, cat);
            });

            try {
                await batch.commit();
                console.log("Categories seeded successfully.");
            } catch (err) {
                console.error("Error seeding categories:", err);
            }
        }

        // FIRESTORE LISTENER (TRANSACTIONS)
        function setupRealtimeListener() {
            if (!currentUser) return;

            // FIX: Use chaining for Compat SDK: .collection().doc().collection()
            // db.collection() does not accept multiple arguments in compat mode.
            const collectionRef = db.collection('artifacts')
                .doc(appId)
                .collection('users')
                .doc(currentUser.uid)
                .collection('expenses');

            collectionRef.onSnapshot((snapshot) => {
                transactions = [];
                snapshot.forEach(doc => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });

                // Sort by date descending in memory
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                updateUI();
            }, (error) => {
                console.error("Data fetch error:", error);
            });
        }

        // UI UPDATES
        function updateUI() {
            renderSummary();
            renderRecentList();
            renderFullList();
            renderChart();
        }

        function renderSummary() {
            let income = 0;
            let expense = 0;

            transactions.forEach(t => {
                if (t.type === 'income') income += Number(t.amount);
                else expense += Number(t.amount);
            });

            const balance = income - expense;

            document.getElementById('totalIncome').textContent = formatCurrency(income);
            document.getElementById('totalExpense').textContent = formatCurrency(expense);
            document.getElementById('totalBalance').textContent = formatCurrency(balance);

            // Update Expense Bar visual
            const totalVol = income + expense;
            const expensePct = totalVol > 0 ? (expense / totalVol) * 100 : 0;
            document.getElementById('expenseBar').style.width = `${Math.min(expensePct, 100)}%`;
        }

        function renderRecentList() {
            const listEl = document.getElementById('recentList');
            listEl.innerHTML = '';

            const recent = transactions.slice(0, 5); // Top 5

            if (recent.length === 0) {
                listEl.innerHTML = `<div class="text-center text-gray-400 py-4 text-sm">No transactions yet.</div>`;
                return;
            }

            recent.forEach(t => {
                listEl.innerHTML += createTransactionRowHTML(t, true);
            });
        }

        function renderFullList() {
            const listEl = document.getElementById('fullTransactionList');
            listEl.innerHTML = '';

            // Filter Logic
            const filterType = document.getElementById('filterType').value;
            const searchStr = document.getElementById('searchInput').value.toLowerCase();

            const filtered = transactions.filter(t => {
                const matchesType = filterType === 'all' || t.type === filterType;
                const matchesSearch = t.note.toLowerCase().includes(searchStr) || getCategoryName(t.type, t.category).toLowerCase().includes(searchStr);
                return matchesType && matchesSearch;
            });

            if (filtered.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                document.getElementById('emptyState').classList.add('hidden');
                filtered.forEach(t => {
                    listEl.innerHTML += createTransactionRowHTML(t, false);
                });
            }
        }

        function renderChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');

            // Aggregate expenses by category
            const catTotals = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                if (!catTotals[t.category]) catTotals[t.category] = 0;
                catTotals[t.category] += Number(t.amount);
            });

            const labels = Object.keys(catTotals).map(k => getCategoryName('expense', k));
            const data = Object.values(catTotals);
            const bgColors = Object.keys(catTotals).map(k => getCategoryColor('expense', k));

            if (expenseChart) expenseChart.destroy();

            // If no expenses, show empty doughnut
            if (data.length === 0) {
                expenseChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['No Data'],
                        datasets: [{ data: [1], backgroundColor: ['#f1f5f9'] }]
                    },
                    options: { plugins: { legend: { display: false } }, cutout: '70%' }
                });
                document.getElementById('chartLegend').innerHTML = '<p class="text-center text-gray-400">Add expenses to see breakdown</p>';
                return;
            }

            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: bgColors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Custom Legend
            const legendEl = document.getElementById('chartLegend');
            legendEl.innerHTML = '';
            Object.keys(catTotals).forEach(catId => {
                const amount = catTotals[catId];
                const pct = ((amount / data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                legendEl.innerHTML += `
                    <div class="flex justify-between items-center p-2 rounded hover:bg-gray-50">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: ${getCategoryColor('expense', catId)}"></div>
                            <span class="text-gray-600">${getCategoryName('expense', catId)}</span>
                        </div>
                        <span class="font-bold text-gray-700">${pct}% <span class="text-xs font-normal text-gray-400">(${formatCurrency(amount)})</span></span>
                    </div>
                `;
            });
        }

        // HELPERS
        function createTransactionRowHTML(t, isCompact) {
            const catConfig = getCategoryConfig(t.type, t.category);
            const amountClass = t.type === 'income' ? 'text-emerald-600' : 'text-gray-800';
            const sign = t.type === 'income' ? '+' : '-';
            const iconBg = t.type === 'income' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-50 text-rose-500'; // Softer red for expense

            if (isCompact) {
                return `
                    <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl transition-colors cursor-pointer border border-transparent hover:border-gray-100 group" onclick="editTransaction('${t.id}')">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full ${iconBg} flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid ${catConfig.icon}"></i>
                            </div>
                            <div class="min-w-0">
                                <p class="text-sm font-bold text-gray-800 truncate">${catConfig.name}</p>
                                <p class="text-xs text-gray-400 truncate">${t.note || 'No note'}</p>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="text-sm font-bold ${amountClass}">${sign}${formatCurrency(t.amount)}</p>
                            <p class="text-xs text-gray-400">${formatDate(t.date)}</p>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <tr class="hover:bg-blue-50/50 transition-colors group">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${iconBg} flex items-center justify-center text-xs">
                                    <i class="fa-solid ${catConfig.icon}"></i>
                                </div>
                                <span class="font-medium text-gray-700">${catConfig.name}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-gray-500 text-xs">${formatDate(t.date)}</td>
                        <td class="px-6 py-4 text-gray-600 max-w-xs truncate" title="${t.note}">${t.note || '-'}</td>
                        <td class="px-6 py-4 text-right font-mono font-medium ${amountClass}">${sign}${formatCurrency(t.amount)}</td>
                        <td class="px-6 py-4 text-center">
                            <div class="flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="editTransaction('${t.id}')" class="p-2 text-blue-500 hover:bg-blue-100 rounded-lg"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteTransaction('${t.id}')" class="p-2 text-rose-500 hover:bg-rose-100 rounded-lg"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        // Updated for Indian Rupee
        function formatCurrency(num) {
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(num);
        }

        // Updated Date Format
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // New Export CSV Feature
        function exportCSV() {
            if (!transactions.length) {
                alert("No transactions to export yet!");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Type,Category,Note,Amount\n"; // Header

            transactions.forEach(t => {
                const row = [
                    t.date,
                    t.type,
                    getCategoryName(t.type, t.category),
                    `"${(t.note || '').replace(/"/g, '""')}"`, // Escape quotes
                    t.amount
                ].join(",");
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "expense_flow_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getCategoryConfig(type, id) {
            // Updated to use the reactive 'categories' object populated from DB
            const list = categories[type] || [];
            return list.find(c => c.id === id) || { name: 'Unknown', icon: 'fa-question', color: '#ccc' };
        }

        function getCategoryName(type, id) { return getCategoryConfig(type, id).name; }
        function getCategoryColor(type, id) { return getCategoryConfig(type, id).color; }

        // NAVIGATION
        function showPage(pageId) {
            document.querySelectorAll('main > div > div[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${pageId}`).classList.remove('hidden');

            // Update Title
            const titles = { 'dashboard': 'Dashboard', 'transactions': 'Transactions' };
            document.getElementById('pageTitle').textContent = titles[pageId];

            // Update Nav State
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-blue-600', 'text-white');
                el.classList.add('text-slate-400');
            });
            const activeNav = document.getElementById(`nav-${pageId}`);
            if (activeNav) {
                activeNav.classList.remove('text-slate-400');
                activeNav.classList.add('bg-blue-600', 'text-white');
            }

            // Close mobile sidebar if open
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        // MODAL & FORMS
        const modal = document.getElementById('transactionModal');
        const form = document.getElementById('transactionForm');

        function openModal() {
            resetForm();
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        function resetForm() {
            form.reset();
            document.getElementById('editId').value = '';
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('modalTitle').textContent = 'Add Transaction';
            setType('expense'); // Default
        }

        function setType(type) {
            document.getElementById('type').value = type;
            const btnExp = document.getElementById('btn-expense');
            const btnInc = document.getElementById('btn-income');

            if (type === 'expense') {
                btnExp.className = "py-2 rounded-lg text-sm font-medium transition-all shadow-sm bg-white text-rose-600 border border-gray-100";
                btnInc.className = "py-2 rounded-lg text-sm font-medium transition-all text-gray-500 hover:text-gray-700 hover:bg-gray-50";
            } else {
                btnExp.className = "py-2 rounded-lg text-sm font-medium transition-all text-gray-500 hover:text-gray-700 hover:bg-gray-50";
                btnInc.className = "py-2 rounded-lg text-sm font-medium transition-all shadow-sm bg-white text-emerald-600 border border-gray-100";
            }
            updateCategoryOptions();
        }

        function updateCategoryOptions() {
            const type = document.getElementById('type').value;
            const select = document.getElementById('category');
            select.innerHTML = '';

            const cats = categories[type] || [];

            if (cats.length === 0) {
                const opt = document.createElement('option');
                opt.textContent = "Loading categories...";
                select.appendChild(opt);
                return;
            }

            cats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                select.appendChild(opt);
            });
        }

        function editTransaction(id) {
            const t = transactions.find(x => x.id === id);
            if (!t) return;

            document.getElementById('editId').value = t.id;
            setType(t.type);
            document.getElementById('amount').value = t.amount;
            document.getElementById('date').value = t.date;
            document.getElementById('note').value = t.note || '';

            // Wait for select to repopulate before setting value
            setTimeout(() => {
                document.getElementById('category').value = t.category;
            }, 0);

            document.getElementById('modalTitle').textContent = 'Edit Transaction';
            modal.classList.remove('hidden');
        }

        // DB ACTIONS
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const editId = document.getElementById('editId').value;
            const data = {
                type: document.getElementById('type').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                date: document.getElementById('date').value,
                note: document.getElementById('note').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Saving...';
            submitBtn.disabled = true;

            try {
                // FIX: Use proper chaining here as well
                const collectionRef = db.collection('artifacts')
                    .doc(appId)
                    .collection('users')
                    .doc(currentUser.uid)
                    .collection('expenses');

                if (editId) {
                    await collectionRef.doc(editId).update(data);
                } else {
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await collectionRef.add(data);
                }
                closeModal();
            } catch (err) {
                console.error(err);
                alert("Error saving transaction. Check console.");
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        window.deleteTransaction = async (id) => {
            if (!confirm("Are you sure you want to delete this?")) return;
            if (!currentUser) return;

            try {
                // FIX: Use proper chaining here as well
                await db.collection('artifacts')
                    .doc(appId)
                    .collection('users')
                    .doc(currentUser.uid)
                    .collection('expenses')
                    .doc(id)
                    .delete();
            } catch (err) {
                console.error(err);
                alert("Failed to delete.");
            }
        };

        // EVENT LISTENERS FOR FILTERS
        document.getElementById('searchInput').addEventListener('input', renderFullList);
        document.getElementById('filterType').addEventListener('change', renderFullList);

        // Start App
        initApp();

    </script>
</body>

</html>