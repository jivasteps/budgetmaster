<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExpenseFlow Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <!-- PWA Manifest (Data URI) -->
    <link rel="manifest" id="manifest-placeholder">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            .mobile-hide { display: none; }
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                position: fixed;
                z-index: 50;
                height: 100vh;
                width: 280px;
            }
            .sidebar.open { transform: translateX(0); }
            .overlay {
                display: none;
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 40;
            }
            .overlay.active { display: block; }
        }

        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-gray-800 h-screen overflow-hidden">

    <!-- LOGIN / LANDING PAGE -->
    <div id="view-landing" class="hidden w-full h-full flex flex-col items-center justify-center bg-white">
        <div class="text-center space-y-6 max-w-md px-6 fade-in">
            <div class="w-20 h-20 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto shadow-xl shadow-blue-200">
                <i class="fa-solid fa-indian-rupee-sign text-white text-3xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">ExpenseFlow Pro</h1>
                <p class="text-gray-500">Track expenses, set budgets, and visualize your financial health.</p>
            </div>
            <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center gap-3 px-6 py-4 border border-gray-200 rounded-xl hover:bg-gray-50 transition-all group relative overflow-hidden">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google Logo">
                <span class="font-semibold text-gray-700">Sign in with Google</span>
            </button>
            <p class="text-xs text-gray-400 mt-8">Secure & Private • Powered by Firebase</p>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div id="app-layout" class="hidden flex h-full w-full">
        <!-- Mobile Overlay -->
        <div id="mobileOverlay" class="overlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar bg-slate-900 text-white w-64 flex-shrink-0 flex flex-col h-full shadow-2xl">
            <div class="p-6 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                        <i class="fa-solid fa-indian-rupee-sign text-white text-sm"></i>
                    </div>
                    <h1 class="text-xl font-bold tracking-tight">ExpenseFlow</h1>
                </div>
                <button class="md:hidden text-gray-400 hover:text-white" onclick="toggleSidebar()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <nav class="flex-1 px-4 py-4 space-y-2">
                <a href="#" onclick="showPage('dashboard')" id="nav-dashboard" class="nav-item flex items-center gap-3 px-4 py-3 bg-blue-600 rounded-xl text-white transition-colors">
                    <i class="fa-solid fa-chart-pie w-5"></i>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="#" onclick="showPage('transactions')" id="nav-transactions" class="nav-item flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-xl transition-colors">
                    <i class="fa-solid fa-list-ul w-5"></i>
                    <span class="font-medium">Transactions</span>
                </a>
                <button id="installBtn" class="hidden w-full flex items-center gap-3 px-4 py-3 text-emerald-400 hover:text-emerald-300 hover:bg-slate-800 rounded-xl transition-colors text-left mt-8">
                    <i class="fa-solid fa-download w-5"></i>
                    <span class="font-medium">Install App</span>
                </button>
            </nav>

            <div class="p-4 border-t border-slate-800">
                <div class="flex items-center gap-3 px-2 py-2 mb-3">
                    <img id="userAvatar" src="" class="w-10 h-10 rounded-full bg-slate-700 object-cover border-2 border-slate-700" alt="User">
                    <div class="overflow-hidden">
                        <p class="text-sm font-medium text-white truncate" id="userName">User</p>
                        <p class="text-xs text-slate-400 truncate" id="userEmail">Loading...</p>
                    </div>
                </div>
                <button onclick="logout()" class="w-full flex items-center justify-center gap-2 py-2 text-xs font-medium text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> Sign Out
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full overflow-hidden bg-gray-50 relative">
            <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 flex-shrink-0">
                <button class="md:hidden text-gray-600 p-2 -ml-2 hover:bg-gray-100 rounded-lg" onclick="toggleSidebar()">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <h2 id="pageTitle" class="text-lg font-semibold text-gray-800">Dashboard</h2>
                <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i>
                    <span class="hidden sm:inline">Add Transaction</span>
                </button>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8" id="mainScroll">
                
                <!-- Dashboard View -->
                <div id="view-dashboard" class="space-y-6 max-w-7xl mx-auto">
                    <!-- BUDGET CARD (NEW) -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="flex-1 w-full">
                            <div class="flex justify-between items-end mb-2">
                                <div>
                                    <p class="text-sm text-gray-500 font-medium">Monthly Budget</p>
                                    <h3 class="text-2xl font-bold text-gray-800"><span id="spentThisMonth">₹0</span> <span class="text-sm font-normal text-gray-400">/ <span id="budgetDisplay">₹0</span></span></h3>
                                </div>
                                <button onclick="openBudgetModal()" class="text-blue-600 text-sm font-medium hover:bg-blue-50 px-3 py-1 rounded-lg transition-colors">Edit Budget</button>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-3">
                                <div id="budgetProgressBar" class="bg-emerald-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <p id="budgetMessage" class="text-xs text-gray-400 mt-2">Set a budget to track progress.</p>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Balance -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                            <div class="absolute right-0 top-0 p-6 opacity-10"><i class="fa-solid fa-scale-balanced text-6xl text-blue-600"></i></div>
                            <p class="text-sm text-gray-500 font-medium mb-1">Total Balance</p>
                            <h3 class="text-3xl font-bold text-gray-800" id="totalBalance">₹0.00</h3>
                        </div>
                        <!-- Income -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                            <div class="absolute right-0 top-0 p-6 opacity-10"><i class="fa-solid fa-arrow-trend-up text-6xl text-emerald-500"></i></div>
                            <p class="text-sm text-gray-500 font-medium mb-1">Total Income</p>
                            <h3 class="text-3xl font-bold text-emerald-600" id="totalIncome">₹0.00</h3>
                        </div>
                        <!-- Expenses -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                            <div class="absolute right-0 top-0 p-6 opacity-10"><i class="fa-solid fa-arrow-trend-down text-6xl text-rose-500"></i></div>
                            <p class="text-sm text-gray-500 font-medium mb-1">Total Expenses</p>
                            <h3 class="text-3xl font-bold text-rose-600" id="totalExpense">₹0.00</h3>
                        </div>
                    </div>

                    <!-- Charts & Recent -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column: Charts -->
                        <div class="lg:col-span-1 space-y-6">
                            <!-- Doughnut Chart -->
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                                <h3 class="text-lg font-bold text-gray-800 w-full mb-4">By Category</h3>
                                <div class="relative w-full max-w-[280px]">
                                    <canvas id="expenseChart"></canvas>
                                </div>
                                <div id="chartLegend" class="w-full mt-6 space-y-2 text-sm"></div>
                            </div>
                        </div>

                        <!-- Right Column: Trend & Recent -->
                        <div class="lg:col-span-2 space-y-6">
                             <!-- Trend Chart (NEW) -->
                             <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">Spending Trend (Last 7 Days)</h3>
                                <div class="w-full h-64">
                                    <canvas id="trendChart"></canvas>
                                </div>
                            </div>

                            <!-- Recent Transactions -->
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-bold text-gray-800">Recent Transactions</h3>
                                    <button onclick="showPage('transactions')" class="text-sm text-blue-600 hover:text-blue-700 font-medium">View All</button>
                                </div>
                                <div class="overflow-y-auto pr-2" style="max-height: 400px;">
                                    <div id="recentList" class="space-y-3">
                                        <div class="text-center py-10 text-gray-400"><div class="loader mx-auto mb-3"></div><p>Loading data...</p></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transactions View -->
                <div id="view-transactions" class="hidden max-w-6xl mx-auto">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-6 border-b border-gray-100 flex flex-col md:flex-row gap-4 justify-between items-center bg-gray-50">
                            <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto flex-1">
                                <div class="relative w-full sm:w-64">
                                    <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400 text-sm"></i>
                                    <input type="text" id="searchInput" placeholder="Search..." class="w-full pl-9 pr-4 py-2 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                                <div class="flex gap-2">
                                    <select id="filterType" class="px-3 py-2 bg-white border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="all">All Types</option>
                                        <option value="income">Income</option>
                                        <option value="expense">Expense</option>
                                    </select>
                                    <!-- NEW DATE FILTER -->
                                    <select id="filterDate" class="px-3 py-2 bg-white border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="all">All Time</option>
                                        <option value="this_month">This Month</option>
                                        <option value="last_month">Last Month</option>
                                        <option value="this_year">This Year</option>
                                    </select>
                                </div>
                            </div>
                            <button onclick="exportCSV()" class="mt-3 md:mt-0 text-gray-600 hover:text-gray-900 text-sm font-medium flex items-center gap-2 px-3 py-2 hover:bg-gray-100 rounded-lg transition-colors">
                                <i class="fa-solid fa-file-csv text-green-600 text-lg"></i> Export CSV
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="bg-gray-50 text-xs uppercase text-gray-500 font-semibold border-b border-gray-100">
                                        <th class="px-6 py-4 rounded-tl-lg">Category</th>
                                        <th class="px-6 py-4">Date</th>
                                        <th class="px-6 py-4">Note</th>
                                        <th class="px-6 py-4 text-right">Amount</th>
                                        <th class="px-6 py-4 rounded-tr-lg text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="fullTransactionList" class="text-sm divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                        <div id="emptyState" class="hidden py-12 flex flex-col items-center justify-center text-gray-400">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4"><i class="fa-solid fa-receipt text-2xl text-gray-300"></i></div>
                            <p>No transactions found.</p>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Add/Edit Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-4">
            <div class="bg-white rounded-2xl shadow-2xl">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800" id="modalTitle">Add Transaction</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <form id="transactionForm" class="p-6 space-y-4">
                    <input type="hidden" id="editId">
                    <div class="grid grid-cols-2 gap-2 bg-gray-100 p-1 rounded-xl">
                        <button type="button" onclick="setType('expense')" id="btn-expense" class="py-2 rounded-lg text-sm font-medium transition-all shadow-sm bg-white text-rose-600">Expense</button>
                        <button type="button" onclick="setType('income')" id="btn-income" class="py-2 rounded-lg text-sm font-medium transition-all text-gray-500 hover:text-gray-700">Income</button>
                    </div>
                    <input type="hidden" id="type" value="expense">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Amount</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">₹</span>
                            <input type="number" step="0.01" id="amount" required class="w-full pl-8 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-lg font-mono" placeholder="0.00">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Category</label>
                        <select id="category" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Date</label>
                        <input type="date" id="date" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-600">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Note (Optional)</label>
                        <input type="text" id="note" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl" placeholder="What was this for?">
                    </div>
                    <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200">Save Transaction</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Budget Modal (New) -->
    <div id="budgetModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeBudgetModal()"></div>
        <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Set Monthly Budget</h3>
                <div class="relative mb-6">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">₹</span>
                    <input type="number" id="budgetInput" class="w-full pl-8 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-lg font-mono" placeholder="e.g. 50000">
                </div>
                <div class="flex gap-3">
                    <button onclick="closeBudgetModal()" class="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded-xl">Cancel</button>
                    <button onclick="saveBudget()" class="flex-1 py-2 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /** APP CONFIG */
        const manifest = { "name": "ExpenseFlow Pro", "short_name": "ExpenseFlow", "start_url": ".", "display": "standalone", "background_color": "#ffffff", "theme_color": "#2563eb", "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/2382/2382533.png", "sizes": "512x512", "type": "image/png" }] };
        document.getElementById('manifest-placeholder').href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));
        
        // Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installBtn').classList.remove('hidden'); });
        document.getElementById('installBtn').addEventListener('click', async () => { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; document.getElementById('installBtn').classList.add('hidden'); } });

        // FIREBASE SETUP
        const firebaseConfig = {
            apiKey: "AIzaSyBSU62EbaZWvRQzhf9nc5hY7-MYhm4Kqyo",
            authDomain: "budgetmaster-d0cbd.firebaseapp.com",
            projectId: "budgetmaster-d0cbd",
            storageBucket: "budgetmaster-d0cbd.firebasestorage.app",
            messagingSenderId: "540237476220",
            appId: "1:540237476220:web:c4026abb2d1e06e360f4f9",
            measurementId: "G-YPK4ZWQLMT"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;
        let transactions = [];
        let categories = { expense: [], income: [] };
        let monthlyBudget = 0;
        let expenseChart = null;
        let trendChart = null;

        const defaultCategoriesList = [
            { id: 'food', type: 'expense', name: 'Food & Dining', icon: 'fa-utensils', color: '#f87171' },
            { id: 'transport', type: 'expense', name: 'Transportation', icon: 'fa-car', color: '#60a5fa' },
            { id: 'shopping', type: 'expense', name: 'Shopping', icon: 'fa-bag-shopping', color: '#c084fc' },
            { id: 'bills', type: 'expense', name: 'Bills & Utilities', icon: 'fa-bolt', color: '#fbbf24' },
            { id: 'entertainment', type: 'expense', name: 'Entertainment', icon: 'fa-film', color: '#f472b6' },
            { id: 'health', type: 'expense', name: 'Health', icon: 'fa-heart-pulse', color: '#34d399' },
            { id: 'other', type: 'expense', name: 'Others', icon: 'fa-circle-question', color: '#94a3b8' },
            { id: 'salary', type: 'income', name: 'Salary', icon: 'fa-money-bill-wave', color: '#10b981' },
            { id: 'freelance', type: 'income', name: 'Freelance', icon: 'fa-laptop-code', color: '#3b82f6' },
            { id: 'investments', type: 'income', name: 'Investments', icon: 'fa-chart-line', color: '#8b5cf6' },
            { id: 'gift', type: 'income', name: 'Gifts', icon: 'fa-gift', color: '#ec4899' },
            { id: 'other_income', type: 'income', name: 'Other Income', icon: 'fa-plus-circle', color: '#64748b' }
        ];

        // --- AUTH ---
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch((error) => {
                if (error.code === 'auth/unauthorized-domain') {
                    alert(`⚠️ DOMAIN NOT AUTHORIZED ⚠️\nAdd this to Firebase Console > Auth > Settings > Authorized Domains:\n${window.location.hostname}`);
                } else {
                    alert("Login failed: " + error.message);
                }
            });
        }

        function logout() { auth.signOut().then(() => window.location.reload()); }

        // --- INIT ---
        async function initApp() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('userName').textContent = user.displayName || 'User';
                    document.getElementById('userEmail').textContent = user.email || 'Guest';
                    document.getElementById('userAvatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName||'User')}&background=374151&color=fff`;
                    document.getElementById('view-landing').classList.add('hidden');
                    document.getElementById('app-layout').classList.remove('hidden');

                    setupCategoriesListener();
                    setupRealtimeListener();
                    loadBudget(); // Load user settings
                } else {
                    document.getElementById('view-landing').classList.remove('hidden');
                    document.getElementById('app-layout').classList.add('hidden');
                }
            });

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && !auth.currentUser) {
                try { await auth.signInWithCustomToken(__initial_auth_token); } catch(e) {}
            }
            document.getElementById('date').valueAsDate = new Date();
        }

        // --- FIRESTORE LISTENERS ---
        function setupCategoriesListener() {
            const catsRef = db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('categories');
            catsRef.onSnapshot(async (snapshot) => {
                if (snapshot.empty) { await seedDefaultCategories(catsRef); return; }
                categories = { expense: [], income: [] };
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.type === 'expense') categories.expense.push(data);
                    else if (data.type === 'income') categories.income.push(data);
                });
                updateCategoryOptions();
                updateUI();
            });
        }

        async function seedDefaultCategories(ref) {
            const batch = db.batch();
            defaultCategoriesList.forEach(cat => batch.set(ref.doc(cat.id), cat));
            await batch.commit();
        }

        function setupRealtimeListener() {
            const collectionRef = db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('expenses');
            collectionRef.onSnapshot((snapshot) => {
                transactions = [];
                snapshot.forEach(doc => transactions.push({ id: doc.id, ...doc.data() }));
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                updateUI();
            });
        }

        // --- BUDGET LOGIC ---
        function loadBudget() {
            db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('settings').doc('general')
              .onSnapshot(doc => {
                  if (doc.exists) {
                      monthlyBudget = doc.data().monthlyBudget || 0;
                  }
                  updateBudgetUI();
              });
        }

        function openBudgetModal() {
            document.getElementById('budgetInput').value = monthlyBudget || '';
            document.getElementById('budgetModal').classList.remove('hidden');
        }
        function closeBudgetModal() { document.getElementById('budgetModal').classList.add('hidden'); }

        async function saveBudget() {
            const val = parseFloat(document.getElementById('budgetInput').value);
            if (isNaN(val) || val < 0) return alert("Invalid budget");
            
            await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('settings').doc('general').set({ monthlyBudget: val }, { merge: true });
            closeBudgetModal();
        }

        function updateBudgetUI() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Calculate spent this month
            const spent = transactions
                .filter(t => t.type === 'expense')
                .filter(t => {
                    const d = new Date(t.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                })
                .reduce((sum, t) => sum + Number(t.amount), 0);

            document.getElementById('budgetDisplay').textContent = formatCurrency(monthlyBudget);
            document.getElementById('spentThisMonth').textContent = formatCurrency(spent);

            const bar = document.getElementById('budgetProgressBar');
            const msg = document.getElementById('budgetMessage');

            if (monthlyBudget > 0) {
                const pct = (spent / monthlyBudget) * 100;
                bar.style.width = `${Math.min(pct, 100)}%`;
                
                if (pct > 100) {
                    bar.className = "bg-rose-500 h-3 rounded-full transition-all duration-500";
                    msg.textContent = `You've exceeded your budget by ${formatCurrency(spent - monthlyBudget)}!`;
                    msg.className = "text-xs text-rose-500 mt-2 font-bold";
                } else if (pct > 80) {
                    bar.className = "bg-orange-400 h-3 rounded-full transition-all duration-500";
                    msg.textContent = "Approaching budget limit.";
                    msg.className = "text-xs text-orange-500 mt-2";
                } else {
                    bar.className = "bg-emerald-500 h-3 rounded-full transition-all duration-500";
                    msg.textContent = "You are within budget.";
                    msg.className = "text-xs text-gray-400 mt-2";
                }
            } else {
                bar.style.width = "0%";
                msg.textContent = "No budget set.";
            }
        }

        // --- UI UPDATES ---
        function updateUI() {
            renderSummary();
            renderRecentList();
            renderFullList();
            renderChart();
            renderTrendChart(); // NEW
            updateBudgetUI();   // NEW
        }

        function renderSummary() {
            let income = 0; let expense = 0;
            transactions.forEach(t => { if (t.type === 'income') income += Number(t.amount); else expense += Number(t.amount); });
            document.getElementById('totalIncome').textContent = formatCurrency(income);
            document.getElementById('totalExpense').textContent = formatCurrency(expense);
            document.getElementById('totalBalance').textContent = formatCurrency(income - expense);
        }

        // Filter Logic Helper
        function isDateInFilter(dateStr, filter) {
            const date = new Date(dateStr);
            const now = new Date();
            if (filter === 'all') return true;
            if (filter === 'this_year') return date.getFullYear() === now.getFullYear();
            if (filter === 'this_month') return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            if (filter === 'last_month') {
                const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                return date.getMonth() === lastMonth.getMonth() && date.getFullYear() === lastMonth.getFullYear();
            }
            return true;
        }

        function renderFullList() {
            const listEl = document.getElementById('fullTransactionList');
            listEl.innerHTML = '';
            const filterType = document.getElementById('filterType').value;
            const filterDate = document.getElementById('filterDate').value;
            const searchStr = document.getElementById('searchInput').value.toLowerCase();
            
            const filtered = transactions.filter(t => {
                const matchesType = filterType === 'all' || t.type === filterType;
                const matchesDate = isDateInFilter(t.date, filterDate);
                const matchesSearch = t.note.toLowerCase().includes(searchStr) || getCategoryName(t.type, t.category).toLowerCase().includes(searchStr);
                return matchesType && matchesSearch && matchesDate;
            });

            if (filtered.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                document.getElementById('emptyState').classList.add('hidden');
                filtered.forEach(t => listEl.innerHTML += createTransactionRowHTML(t, false));
            }
        }

        function renderRecentList() {
            const listEl = document.getElementById('recentList');
            listEl.innerHTML = '';
            const recent = transactions.slice(0, 5);
            if(recent.length === 0) { listEl.innerHTML = `<div class="text-center text-gray-400 py-4 text-sm">No transactions yet.</div>`; return; }
            recent.forEach(t => listEl.innerHTML += createTransactionRowHTML(t, true));
        }

        // --- CHARTS ---
        function renderChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const catTotals = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                if (!catTotals[t.category]) catTotals[t.category] = 0;
                catTotals[t.category] += Number(t.amount);
            });
            const labels = Object.keys(catTotals).map(k => getCategoryName('expense', k));
            const data = Object.values(catTotals);
            const bgColors = Object.keys(catTotals).map(k => getCategoryColor('expense', k));

            if (expenseChart) expenseChart.destroy();
            expenseChart = new Chart(ctx, { 
                type: 'doughnut', 
                data: { labels: labels.length?labels:['No Data'], datasets: [{ data: data.length?data:[1], backgroundColor: data.length?bgColors:['#f1f5f9'], borderWidth: 0 }] }, 
                options: { responsive: true, maintainAspectRatio: true, cutout: '75%', plugins: { legend: { display: false } } } 
            });

            const legendEl = document.getElementById('chartLegend');
            legendEl.innerHTML = '';
            const total = data.reduce((a,b)=>a+b,0);
            Object.keys(catTotals).forEach(catId => {
                const amount = catTotals[catId];
                const pct = total ? ((amount / total) * 100).toFixed(1) : 0;
                legendEl.innerHTML += `<div class="flex justify-between items-center p-2 rounded hover:bg-gray-50"><div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full" style="background-color: ${getCategoryColor('expense', catId)}"></div><span class="text-gray-600">${getCategoryName('expense', catId)}</span></div><span class="font-bold text-gray-700">${pct}% <span class="text-xs font-normal text-gray-400">(${formatCurrency(amount)})</span></span></div>`;
            });
        }

        // NEW: Trend Line Chart
        function renderTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // Get last 7 days labels
            const labels = [];
            const dataMap = {};
            for(let i=6; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0]; // YYYY-MM-DD
                labels.push(d.toLocaleDateString('en-IN', {weekday:'short'}));
                dataMap[dateStr] = 0;
            }

            // Fill data
            transactions.filter(t => t.type === 'expense').forEach(t => {
                // Assuming t.date is YYYY-MM-DD
                if(dataMap.hasOwnProperty(t.date)) {
                    dataMap[t.date] += Number(t.amount);
                }
            });

            const dataPoints = Object.values(dataMap);

            if (trendChart) trendChart.destroy();
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Spending',
                        data: dataPoints,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // --- HELPERS ---
        function createTransactionRowHTML(t, isCompact) {
            const cat = getCategoryConfig(t.type, t.category);
            const isInc = t.type === 'income';
            const color = isInc ? 'text-emerald-600' : 'text-gray-800';
            const bg = isInc ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-50 text-rose-500';
            const sign = isInc ? '+' : '-';
            const dateDisplay = formatDate(t.date);

            if (isCompact) {
                return `<div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl cursor-pointer group" onclick="editTransaction('${t.id}')">
                    <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full ${bg} flex items-center justify-center flex-shrink-0"><i class="fa-solid ${cat.icon}"></i></div>
                    <div class="min-w-0"><p class="text-sm font-bold text-gray-800 truncate">${cat.name}</p><p class="text-xs text-gray-400 truncate">${t.note||'No note'}</p></div></div>
                    <div class="text-right flex-shrink-0"><p class="text-sm font-bold ${color}">${sign}${formatCurrency(t.amount)}</p><p class="text-xs text-gray-400">${dateDisplay}</p></div></div>`;
            } else {
                return `<tr class="hover:bg-blue-50/50 group"><td class="px-6 py-4"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full ${bg} flex items-center justify-center text-xs"><i class="fa-solid ${cat.icon}"></i></div><span class="font-medium text-gray-700">${cat.name}</span></div></td>
                <td class="px-6 py-4 text-gray-500 text-xs">${dateDisplay}</td><td class="px-6 py-4 text-gray-600 max-w-xs truncate" title="${t.note}">${t.note||'-'}</td>
                <td class="px-6 py-4 text-right font-mono font-medium ${color}">${sign}${formatCurrency(t.amount)}</td>
                <td class="px-6 py-4 text-center"><div class="flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onclick="editTransaction('${t.id}')" class="p-2 text-blue-500 hover:bg-blue-100 rounded-lg"><i class="fa-solid fa-pen"></i></button>
                <button onclick="deleteTransaction('${t.id}')" class="p-2 text-rose-500 hover:bg-rose-100 rounded-lg"><i class="fa-solid fa-trash"></i></button></div></td></tr>`;
            }
        }

        function formatCurrency(num) { return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(num); }
        function formatDate(d) { return new Date(d).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }); }
        function getCategoryConfig(type, id) { return (categories[type]||[]).find(c=>c.id===id) || {name:'Unknown',icon:'fa-question',color:'#ccc'}; }
        function getCategoryName(type, id) { return getCategoryConfig(type, id).name; }
        function getCategoryColor(type, id) { return getCategoryConfig(type, id).color; }

        function exportCSV() {
            if(!transactions.length) return alert("No data");
            let csv = "data:text/csv;charset=utf-8,Date,Type,Category,Note,Amount\n";
            transactions.forEach(t => csv += `${t.date},${t.type},${getCategoryName(t.type, t.category)},"${(t.note||'').replace(/"/g,'""')}",${t.amount}\n`);
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "expenses.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        // --- NAVIGATION & MODALS ---
        function showPage(id) {
            document.querySelectorAll('main > div > div[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            document.getElementById('pageTitle').textContent = id === 'dashboard' ? 'Dashboard' : 'Transactions';
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('bg-blue-600', 'text-white'); el.classList.add('text-slate-400'); });
            const active = document.getElementById(`nav-${id}`); if(active) { active.classList.remove('text-slate-400'); active.classList.add('bg-blue-600', 'text-white'); }
            if(document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('mobileOverlay').classList.toggle('active'); }
        
        const modal = document.getElementById('transactionModal');
        const form = document.getElementById('transactionForm');
        function openModal() { form.reset(); document.getElementById('editId').value=''; document.getElementById('date').valueAsDate=new Date(); setType('expense'); modal.classList.remove('hidden'); }
        function closeModal() { modal.classList.add('hidden'); }
        
        function setType(type) {
            document.getElementById('type').value = type;
            const bE = document.getElementById('btn-expense'), bI = document.getElementById('btn-income');
            if(type==='expense'){ bE.className="py-2 rounded-lg text-sm font-medium shadow-sm bg-white text-rose-600 border border-gray-100"; bI.className="py-2 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-50"; }
            else { bE.className="py-2 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-50"; bI.className="py-2 rounded-lg text-sm font-medium shadow-sm bg-white text-emerald-600 border border-gray-100"; }
            updateCategoryOptions();
        }

        function updateCategoryOptions() {
            const type = document.getElementById('type').value, sel = document.getElementById('category'); sel.innerHTML='';
            const list = categories[type]||[];
            if(!list.length) { sel.innerHTML='<option>Loading...</option>'; return; }
            list.forEach(c => { const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; sel.appendChild(o); });
        }

        function editTransaction(id) {
            const t = transactions.find(x=>x.id===id); if(!t) return;
            document.getElementById('editId').value=t.id; setType(t.type);
            document.getElementById('amount').value=t.amount; document.getElementById('date').value=t.date; document.getElementById('note').value=t.note||'';
            setTimeout(()=>document.getElementById('category').value=t.category, 0);
            document.getElementById('modalTitle').textContent='Edit Transaction'; modal.classList.remove('hidden');
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault(); if(!currentUser) return;
            const editId = document.getElementById('editId').value;
            const data = { type: document.getElementById('type').value, amount: parseFloat(document.getElementById('amount').value), category: document.getElementById('category').value, date: document.getElementById('date').value, note: document.getElementById('note').value, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
            const btn = form.querySelector('button[type="submit"]'); btn.disabled=true;
            try {
                const ref = db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('expenses');
                if(editId) await ref.doc(editId).update(data); else { data.createdAt = firebase.firestore.FieldValue.serverTimestamp(); await ref.add(data); }
                closeModal();
            } catch(e) { console.error(e); alert("Error saving"); } finally { btn.disabled=false; }
        });

        window.deleteTransaction = async (id) => { if(!confirm("Delete?")) return; try { await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('expenses').doc(id).delete(); } catch(e){ alert("Failed"); } };

        document.getElementById('searchInput').addEventListener('input', renderFullList);
        document.getElementById('filterType').addEventListener('change', renderFullList);
        document.getElementById('filterDate').addEventListener('change', renderFullList); // NEW Listener

        initApp();
    </script>
</body>
</html>